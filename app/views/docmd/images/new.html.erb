<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900">上傳圖片</h2>
    </div>

    <div class="px-6 py-6">
      <%= form_with scope: :image, url: images_path, local: true, html: { multipart: true } do |form| %>

        <div class="space-y-6">
          <!-- 檔案選擇 -->
          <div>
            <%= form.label :file, "選擇圖片", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.file_field :file,
                required: true,
                accept: "image/jpeg,image/jpg,image/png,image/gif,image/svg+xml,image/webp",
                class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",
                onchange: "previewImage(event)" %>
            <p class="mt-1 text-sm text-gray-500">支援格式：JPG, PNG, GIF, SVG, WebP (最大 10MB)</p>
          </div>

          <!-- 子目錄（可選） -->
          <div>
            <%= form.label :subdirectory, "子目錄（可選）", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.text_field :subdirectory,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                placeholder: "例如：aws 或 screenshots (留空則上傳到根目錄)" %>
            <p class="mt-1 text-sm text-gray-500">圖片將上傳到：docs/assets/images/<span id="pathPreview"></span></p>
          </div>

          <!-- 圖片預覽區域 -->
          <div id="imagePreview" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">預覽</label>
            <div class="border rounded-lg p-4 bg-gray-50">
              <img id="preview" src="" alt="圖片預覽" class="max-w-full h-auto max-h-96 mx-auto rounded">
              <div id="imageInfo" class="mt-3 text-sm text-gray-600 text-center"></div>
            </div>
          </div>

          <!-- 使用說明 -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-900 mb-2">使用提示</h4>
            <ul class="text-sm text-blue-700 space-y-1">
              <li>• 上傳後可在圖片管理頁面查看所有圖片</li>
              <li>• 在 Markdown 中使用：<code class="bg-white px-1 py-0.5 rounded">![說明](/docmd/images/檔名)</code></li>
              <li>• 子目錄可幫助組織圖片（例如：將所有截圖放在 screenshots 資料夾）</li>
            </ul>
          </div>
        </div>

        <div class="mt-6 flex items-center space-x-4">
          <button type="submit" id="submitBtn" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            上傳圖片
          </button>
          <%= link_to images_path, class: "inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg bg-white text-gray-700 border border-gray-200 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            取消
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // 圖片預覽功能
  function previewImage(event) {
    const file = event.target.files[0];
    const previewDiv = document.getElementById('imagePreview');
    const preview = document.getElementById('preview');
    const imageInfo = document.getElementById('imageInfo');

    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();

      reader.onload = function(e) {
        preview.src = e.target.result;
        previewDiv.classList.remove('hidden');

        // 顯示檔案資訊
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        imageInfo.innerHTML = `
          檔名：${file.name}<br>
          大小：${sizeMB} MB<br>
          類型：${file.type}
        `;

        // 檢查檔案大小
        if (file.size > 10 * 1024 * 1024) { // 10MB
          alert('檔案大小超過 10MB 限制！');
          event.target.value = '';
          previewDiv.classList.add('hidden');
          document.getElementById('submitBtn').disabled = true;
        } else {
          document.getElementById('submitBtn').disabled = false;
        }
      };

      reader.readAsDataURL(file);
    }
  }

  // 更新路徑預覽
  document.addEventListener('DOMContentLoaded', function() {
    const subdirInput = document.querySelector('input[name="image[subdirectory]"]');
    const pathPreview = document.getElementById('pathPreview');

    subdirInput.addEventListener('input', function() {
      if (this.value) {
        pathPreview.textContent = this.value + '/';
      } else {
        pathPreview.textContent = '';
      }
    });
  });
</script>